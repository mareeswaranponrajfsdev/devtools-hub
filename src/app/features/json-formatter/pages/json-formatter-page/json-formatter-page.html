<div class="container py-3">

  <!-- Session Restore Banner -->
  <!-- <app-session-restore
    [sessionData]="savedSession()"
    [title]="'Previous JSON Session Found'"
    (restore)="onRestoreSession()"
    (discard)="onDiscardSession()">
  </app-session-restore> -->

  <!-- Performance Mode Alert -->
  <app-performance-mode
    [mode]="performanceMode()">
  </app-performance-mode>

  <!-- Toolbar -->
  <app-json-toolbar
    [live]="store.liveMode()"
    [treeView]="store.treeView()"
    [disabled]="!store.input()"
    [formatterOptions]="store.formatterOptions()"
    (format)="onFormat()"
    (minify)="onMinify()"
    (clear)="onClear()"
    (copy)="store.copy()"
    (toggleLive)="store.toggleLive()"
    (toggleTree)="store.toggleTreeView()"
    (sample)="loadSample()"
    (autoFix)="store.autoFixJson()"
    (validate)="onValidate()"
    (optionsChange)="onOptionsChange($event)"
    [historyRefresh]="historyRefresh()"
    (historyRestore)="onHistoryRestore($event)">
  </app-json-toolbar>


  <!-- Processing Indicator -->
  @if (store.isProcessing()) {
    <div class="processing-indicator">
      <i class="fa-solid fa-spinner fa-spin"></i>
      Processing…
    </div>
  }

  <!-- Status Message -->
  @if (store.error() && !store.isProcessing()) {
    <div class="alert"
      [class.alert-success]="store.error()!.startsWith('✓')"
      [class.alert-danger]="store.error()!.startsWith('✗') || store.error()!.includes('Invalid')"
      [class.alert-info]="!store.error()!.startsWith('✓') && !store.error()!.startsWith('✗') && !store.error()!.includes('Invalid')">
      <i class="fa-solid"
         [class.fa-circle-check]="store.error()!.startsWith('✓')"
         [class.fa-circle-exclamation]="store.error()!.startsWith('✗') || store.error()!.includes('Invalid')"
         [class.fa-circle-info]="!store.error()!.startsWith('✓') && !store.error()!.startsWith('✗') && !store.error()!.includes('Invalid')">
      </i>
      {{ store.error() }}

      <!-- Close button for errors -->
      @if (store.error()!.startsWith('✗') || store.error()!.includes('Invalid')) {
        <button class="alert-close" type="button" (click)="store.error.set(null)" title="Dismiss">
          <i class="fa-solid fa-xmark"></i>
        </button>
      }
    </div>
  }

  <!-- Editors Row -->
  <div class="row g-3">

    <!-- ── INPUT ── -->
    <div class="col-12 col-lg-6">
      <div class="editor-card" #inputContainer>

        <div class="editor-header">
          <h6 class="editor-title">Input JSON</h6>
          <div class="input-actions">

            <app-import-menu (importAction)="onImport($event)"></app-import-menu>

            <button class="action-btn" type="button" [disabled]="!store.canUndo()" (click)="onUndo()" title="Undo (Ctrl+Z)">
              <i class="fa-solid fa-undo"></i>
            </button>
            <button class="action-btn" type="button" [disabled]="!store.canRedo()" (click)="onRedo()" title="Redo (Ctrl+Y)">
              <i class="fa-solid fa-redo"></i>
            </button>
            <button class="action-btn" type="button" [disabled]="!store.input()" (click)="printInput()" title="Print JSON">
              <i class="fa-solid fa-print"></i>
            </button>
            <button class="action-btn fullscreen-btn" type="button"
              (click)="toggleFullscreenInput()"
              [title]="isFullscreenInput ? 'Exit Fullscreen' : 'Fullscreen'">
              <i class="fa-solid" [class.fa-expand]="!isFullscreenInput" [class.fa-compress]="isFullscreenInput"></i>
            </button>

            <div class="stats-inline">
              <span>{{ store.charCount() }} chars</span>
              <span>•</span>
              <span>{{ store.lineCount() }} lines</span>
              <span>•</span>
              <span>{{ store.fileSize() }} KB</span>
            </div>

          </div>
        </div>

        <div class="editor-wrapper">
          <app-json-editor
            [value]="store.input()"
            placeholder="Paste your JSON here, or drag & drop a .json file…"
            (valueChange)="store.setInput($event)">
          </app-json-editor>
        </div>

      </div>
    </div>

    <!-- ── OUTPUT ── -->
    <div class="col-12 col-lg-6">
      <div class="editor-card" #outputContainer>

        <div class="editor-header">
          <h6 class="editor-title">
            @if (store.currentConversion()) {
              {{ store.currentConversion()!.toUpperCase() }} Output
            } @else if (store.filterActive()) {
              Filtered Output
            } @else {
              {{ store.treeView() ? 'Tree View' : 'Formatted Output' }}
            }
          </h6>

          <div class="output-actions">

            <!-- Convert Dropdown -->
            @if (!store.treeView()) {
              <div class="convert-dropdown" [class.open]="convertOpen()">
                <button class="action-btn convert-btn" type="button"
                  [disabled]="!store.output()"
                  (click)="$event.stopPropagation(); toggleConvert()"
                  title="Convert JSON">
                  <i class="fa-solid fa-arrow-right-arrow-left"></i>
                  Convert
                  <i class="fa-solid fa-caret-down convert-caret" [class.rotated]="convertOpen()"></i>
                </button>
                <div class="dropdown-menu" (click)="$event.stopPropagation()">
                  <button (click)="onConvert('xml')">
                    <i class="fa-solid fa-code"></i> JSON → XML
                  </button>
                  <button (click)="onConvert('csv')">
                    <i class="fa-solid fa-table"></i> JSON → CSV
                  </button>
                  <button (click)="onConvert('yaml')">
                    <i class="fa-solid fa-file-code"></i> JSON → YAML
                  </button>
                  @if (store.currentConversion()) {
                    <button class="reset-btn" (click)="onConvert(null)">
                      <i class="fa-solid fa-rotate-left"></i> Back to JSON
                    </button>
                  }
                </div>
              </div>
            }

            <!-- Transform Button -->
            <button
              class="action-btn transform-btn"
              type="button"
              [disabled]="!store.output()"
              [class.active]="store.filterActive()"
              (click)="openTransform()"
              title="JMESPath Transform">
              <i class="fa-solid fa-filter"></i>
              Transform
            </button>

            <!-- Reset Filter -->
            @if (store.filterActive()) {
              <button class="action-btn reset-filter-btn" type="button"
                (click)="store.resetFilter()"
                title="Reset transform / filter">
                <i class="fa-solid fa-rotate-left"></i>
              </button>
            }

            <!-- Save Menu -->
            <app-save-menu [disabled]="!store.output()" (save)="onSave($event)"></app-save-menu>

            <!-- Fullscreen -->
            <button class="action-btn fullscreen-btn" type="button"
              (click)="toggleFullscreenOutput()"
              [title]="isFullscreenOutput ? 'Exit Fullscreen' : 'Fullscreen'">
              <i class="fa-solid" [class.fa-expand]="!isFullscreenOutput" [class.fa-compress]="isFullscreenOutput"></i>
              {{ isFullscreenOutput ? 'Minimize' : 'Fullscreen' }}
            </button>

            <!-- Copy -->
            <button class="action-btn" type="button"
              [class.copied]="copied"
              [disabled]="!store.output()"
              (click)="copyOutput()">
              <i class="fa-solid" [class.fa-copy]="!copied" [class.fa-circle-check]="copied"></i>
              {{ copied ? 'Copied' : 'Copy' }}
            </button>

            <!-- Download .json -->
            <button class="action-btn" type="button" [disabled]="!store.output()" (click)="downloadJson()">
              <i class="fa-solid fa-download"></i>.json
            </button>

            <!-- Download .txt -->
            <button class="action-btn" type="button" [disabled]="!store.output()" (click)="downloadTxt()">
              <i class="fa-regular fa-file-lines"></i>.txt
            </button>

          </div>
        </div>

        <div class="output-wrapper">
          @if (store.treeView()) {
            <app-json-tree [jsonString]="store.output()"></app-json-tree>
          } @else {
            <app-json-editor [value]="store.output()"></app-json-editor>
          }
        </div>

      </div>
    </div>

  </div><!-- /row -->

</div><!-- /container -->

<!-- JMESPath Transform Modal -->
<app-transform-modal
  [isOpen]="store.showTransform()"
  [jsonSource]="store.output() || store.input()"
  (apply)="onTransformApply($event)"
  (closed)="closeTransform()">
</app-transform-modal>

<!-- CSV Export Modal -->
<app-csv-export-modal
  [isOpen]="showCsvModal()"
  [jsonData]="store.output()"
  (close)="this.showCsvModal.set(false)"
  (saved)="this.showCsvModal.set(false)">
</app-csv-export-modal>
